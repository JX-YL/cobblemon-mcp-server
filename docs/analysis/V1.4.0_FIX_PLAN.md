# v1.4.0 修复方案

## 问题根因

对比官方 species 文件后发现的问题：

### 1. 数据类型错误 ❌
| 字段 | v1.4.0 使用 | 官方格式 | 修复 |
|------|-----------|---------|------|
| `height` | 浮点数（米） | **整数（分米）** | 1.0m → 10 |
| `weight` | 浮点数（kg） | **整数（百克）** | 6.9kg → 69 |

### 2. 缺少必需字段 ❌
```json
{
  "implemented": true,           // 缺失 ❌
  "labels": ["custom"],          // 缺失 ❌
  "aspects": [],                 // 缺失 ❌
  "baseExperienceYield": 64,     // 缺失 ❌
  "experienceGroup": "medium_fast", // 缺失 ❌
  "hitbox": {                    // 缺失 ❌
    "width": 0.9,
    "height": 1.0,
    "fixed": false
  },
  "drops": {                     // 缺失 ❌
    "amount": 1,
    "entries": []
  }
}
```

### 3. 字段顺序错误 ❌
官方顺序：
1. implemented
2. nationalPokedexNumber
3. name
4. primaryType
5. secondaryType (可选)
6. maleRatio
7. height
8. weight
9. pokedex
10. labels
11. aspects
12. abilities
13. eggGroups
14. baseStats
15. evYield
16. baseExperienceYield
17. experienceGroup
18. catchRate
19. eggCycles
20. baseFriendship
21. shoulderMountable (可选)
22. baseScale
23. hitbox
24. behaviour (可选)
25. drops
26. moves
27. evolutions
28. forms

---

## 修复方案

### 修改 `server.py`

1. **添加必需字段**：
```python
species = {
    "implemented": true,
    "nationalPokedexNumber": dex,
    "name": name,
    "primaryType": primary_type,
    # ... 按官方顺序排列
    "labels": ["custom"],
    "aspects": [],
    "baseExperienceYield": 64,
    "experienceGroup": "medium_fast",
    "hitbox": {
        "width": 0.9,
        "height": 1.0,
        "fixed": false
    },
    "drops": {
        "amount": 1,
        "entries": []
    }
}
```

2. **修正数据类型**：
```python
# v1.4.0 旧代码
height=0.7,  # 米（浮点数）❌
weight=6.9,  # 千克（浮点数）❌

# v1.4.0 修复
height=7,    # 分米（整数）✓  (0.7m = 7dm)
weight=69,   # 百克（整数）✓  (6.9kg = 69hg)
```

3. **修改函数签名**：
```python
def create_pokemon_with_stats(
    # v1.4.0 新增（修复后）
    height: int = 10,        # 分米
    weight: int = 100,       # 百克
    # ...
):
    # 转换为官方格式
    species["height"] = height  # 直接使用整数
    species["weight"] = weight  # 直接使用整数
```

---

## 兼容性验证

### ✅ 参考官方案例

**Eevee**:
```json
{
  "maleRatio": 0.875,
  "height": 3,          // 0.3m
  "weight": 65,         // 6.5kg
  "abilities": ["runaway", "adaptability", "h:anticipation"],
  "catchRate": 45,
  "eggCycles": 35,
  "baseFriendship": 50,
  "evYield": {
    "special_defence": 1
  }
}
```

**Mewtwo**:
```json
{
  "maleRatio": -1,
  "height": 20,         // 2.0m
  "weight": 1220,       // 122kg
  "abilities": ["pressure", "h:unnerve"],
  "catchRate": 3,
  "eggCycles": 120,
  "baseFriendship": 0,
  "evYield": {
    "special_attack": 3
  }
}
```

---

## 测试计划

1. **单元测试**：
   - 验证 height/weight 转换
   - 验证必需字段存在
   - 验证字段顺序

2. **集成测试**：
   - 生成测试包
   - 导入 Minecraft
   - 验证可加载
   - 验证显示正确

3. **回归测试**：
   - 确保 v1.3.0 功能不受影响

---

## 实施步骤

### Phase 1: 修改代码
- [ ] 更新 `server.py` 字段顺序
- [ ] 添加必需字段
- [ ] 修改 height/weight 为整数

### Phase 2: 更新验证器
- [ ] 更新 `StatsValidator` 验证 height/weight 范围
- [ ] 添加必需字段验证

### Phase 3: 测试
- [ ] 生成测试包
- [ ] 游戏内加载测试
- [ ] 验证所有新功能

### Phase 4: 发布
- [ ] 更新文档
- [ ] 创建 v1.4.1 (修复版)
- [ ] 推送到 GitHub

---

## 单位换算参考

| 实际值 | height (分米) | weight (百克) |
|--------|--------------|--------------|
| 0.3m, 6.5kg | 3 | 65 |
| 0.7m, 6.9kg | 7 | 69 |
| 1.0m, 10kg | 10 | 100 |
| 1.5m, 46.8kg | 15 | 468 |
| 2.0m, 122kg | 20 | 1220 |

---

**预计修复时间**: 30分钟  
**风险等级**: 低（仅修改数据格式）  
**向后兼容**: 是（v1.3.0 功能不变）

