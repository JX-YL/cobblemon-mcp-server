# v1.7.0 掉落物品与描述系统 - 设计文档

## 📋 目标

**核心目标**：支持宝可梦掉落物品配置和图鉴描述

**覆盖率提升**：75% → 82% (+7%)

---

## 🎯 功能需求分析

### 1. 掉落物系统（Drops System）

#### 官方格式分析

从参考包（charmander.json）分析，官方支持：

```json
"drops": {
  "amount": 2,           // 掉落物品数量
  "entries": [            // 掉落条目列表
    {
      "item": "minecraft:blaze_powder",    // 物品ID
      "quantityRange": "0-1"               // 数量范围
    },
    {
      "item": "cobblemon:charcoal_stick",  // Cobblemon物品
      "percentage": 5.0                     // 掉落概率（百分比）
    }
  ]
}
```

**关键字段**：
- `amount` - 掉落物品数量（整数）
- `entries` - 掉落条目数组
- `item` - 物品ID（支持 `minecraft:` 和 `cobblemon:` 命名空间）
- `quantityRange` - 数量范围（字符串，如 "0-1", "1-3"）
- `percentage` - 掉落概率（浮点数，0-100）

---

### 2. 图鉴描述系统（Pokedex Description）

#### 官方格式

```json
"pokedex": [
  "cobblemon.species.charmander.desc"
]
```

**特点**：
- 翻译键格式：`cobblemon.species.{宝可梦名}.desc`
- 支持多语言（需配合 lang 文件）

---

### 3. 标签系统（Labels）

```json
"labels": [
  "gen1",
  "starter",
  "custom"
]
```

**常用标签**：
- `gen1` - `gen8`：世代标签
- `starter`：御三家
- `legendary`：传说宝可梦
- `mythical`：幻之宝可梦
- `custom`：自定义宝可梦

---

### 4. 蛋组系统（Egg Groups）

```json
"eggGroups": [
  "monster",
  "dragon"
]
```

**官方蛋组**：
- `monster`：怪兽
- `water1`, `water2`, `water3`：水中1、2、3
- `bug`：虫
- `flying`：飞行
- `field`：陆上
- `fairy`：妖精
- `grass`：植物
- `human_like`：人型
- `mineral`：矿物
- `amorphous`：不定形
- `dragon`：龙
- `undiscovered`：未发现（不可生蛋）

---

## 🔧 技术实现

### 1. 掉落物验证器（DropValidator）

**路径**：`tools/validators/drop_validator.py`

**功能**：
```python
class DropValidator:
    """验证掉落物配置"""
    
    # Minecraft 原版物品
    MINECRAFT_ITEMS = [
        "stone", "cobblestone", "iron_ingot", "gold_ingot",
        "diamond", "emerald", "coal", "blaze_powder", ...
    ]
    
    # Cobblemon 物品
    COBBLEMON_ITEMS = [
        "poke_ball", "great_ball", "ultra_ball", "master_ball",
        "rare_candy", "exp_candy_xs", "charcoal_stick", ...
    ]
    
    @staticmethod
    def validate_item_id(item_id: str) -> tuple[bool, str]:
        """验证物品ID是否有效"""
        if ":" not in item_id:
            return False, "物品ID必须包含命名空间（如 minecraft:stone）"
        
        namespace, item_name = item_id.split(":", 1)
        
        if namespace == "minecraft":
            if item_name in DropValidator.MINECRAFT_ITEMS:
                return True, ""
            else:
                return False, f"未知的Minecraft物品: {item_name}"
        elif namespace == "cobblemon":
            if item_name in DropValidator.COBBLEMON_ITEMS:
                return True, ""
            else:
                return False, f"未知的Cobblemon物品: {item_name}"
        else:
            # 允许其他模组的物品（警告但不阻止）
            return True, f"警告: 使用了第三方模组物品 {item_id}"
    
    @staticmethod
    def validate_quantity_range(range_str: str) -> tuple[bool, str]:
        """验证数量范围格式"""
        if "-" not in range_str:
            return False, "数量范围格式错误，应为 'min-max' (如 '0-1', '1-3')"
        
        try:
            min_val, max_val = range_str.split("-")
            min_num = int(min_val)
            max_num = int(max_val)
            
            if min_num < 0 or max_num < 0:
                return False, "数量不能为负数"
            if min_num > max_num:
                return False, f"最小值({min_num})不能大于最大值({max_num})"
            
            return True, ""
        except ValueError:
            return False, "数量范围必须是整数"
    
    @staticmethod
    def validate_percentage(percentage: float) -> tuple[bool, str]:
        """验证掉落概率"""
        if percentage < 0 or percentage > 100:
            return False, f"掉落概率必须在0-100之间，当前值: {percentage}"
        return True, ""
    
    @staticmethod
    def validate_drops(drops_config: dict) -> tuple[bool, list]:
        """验证完整的掉落物配置"""
        errors = []
        
        # 验证 amount
        amount = drops_config.get("amount", 0)
        if not isinstance(amount, int) or amount < 0:
            errors.append(f"amount 必须是非负整数，当前值: {amount}")
        
        # 验证 entries
        entries = drops_config.get("entries", [])
        if not isinstance(entries, list):
            errors.append("entries 必须是列表")
            return False, errors
        
        for i, entry in enumerate(entries):
            # 验证物品ID
            item_id = entry.get("item")
            if not item_id:
                errors.append(f"条目 #{i+1}: 缺少 item 字段")
                continue
            
            is_valid, msg = DropValidator.validate_item_id(item_id)
            if not is_valid:
                errors.append(f"条目 #{i+1}: {msg}")
            
            # 验证数量范围（可选）
            if "quantityRange" in entry:
                is_valid, msg = DropValidator.validate_quantity_range(entry["quantityRange"])
                if not is_valid:
                    errors.append(f"条目 #{i+1}: {msg}")
            
            # 验证掉落概率（可选）
            if "percentage" in entry:
                is_valid, msg = DropValidator.validate_percentage(entry["percentage"])
                if not is_valid:
                    errors.append(f"条目 #{i+1}: {msg}")
        
        return len(errors) == 0, errors
```

---

### 2. server.py 更新

**新增参数**：

```python
async def create_pokemon_with_stats(
    # ... 现有参数 ...
    
    # v1.7.0: 掉落物与描述系统
    drop_items: list = None,          # 简化接口：[{"item": "minecraft:stone", "percentage": 5.0}]
    drop_amount: int = 1,              # 掉落物品数量
    labels: list = None,               # 标签（如 ["gen1", "starter"]）
    egg_groups: list = None,           # 蛋组（如 ["monster", "dragon"]）
    pokedex_key: str = None            # 图鉴翻译键（可选，默认自动生成）
) -> dict:
```

**处理逻辑**：

```python
# 处理掉落物
if drop_items:
    from tools.validators.drop_validator import DropValidator
    
    drops_config = {
        "amount": drop_amount,
        "entries": []
    }
    
    for item_config in drop_items:
        # 验证物品ID
        is_valid, msg = DropValidator.validate_item_id(item_config["item"])
        if not is_valid:
            return {"success": False, "error": msg}
        
        entry = {"item": item_config["item"]}
        
        # 添加可选字段
        if "quantityRange" in item_config:
            is_valid, msg = DropValidator.validate_quantity_range(item_config["quantityRange"])
            if not is_valid:
                return {"success": False, "error": msg}
            entry["quantityRange"] = item_config["quantityRange"]
        
        if "percentage" in item_config:
            is_valid, msg = DropValidator.validate_percentage(item_config["percentage"])
            if not is_valid:
                return {"success": False, "error": msg}
            entry["percentage"] = item_config["percentage"]
        
        drops_config["entries"].append(entry)
    
    species["drops"] = drops_config
else:
    # 默认空掉落
    species["drops"] = {"amount": 1, "entries": []}

# 处理图鉴描述
if pokedex_key:
    species["pokedex"] = [pokedex_key]
else:
    species["pokedex"] = [f"cobblemon.species.{name.lower()}.desc"]

# 处理标签
if labels:
    species["labels"] = labels
else:
    species["labels"] = ["custom"]

# 处理蛋组
if egg_groups:
    species["eggGroups"] = egg_groups
else:
    species["eggGroups"] = ["undiscovered"]
```

---

## 🧪 测试策略（渐进式）

### Step 1: 基础掉落物测试
```python
# 测试宝可梦1：SimpleDrop（单个掉落物）
create_pokemon_with_stats(
    name="SimpleDrop",
    dex=10701,
    primary_type="normal",
    drop_items=[
        {"item": "minecraft:stone", "percentage": 100.0}
    ]
)
```

### Step 2: 多掉落物测试
```python
# 测试宝可梦2：MultiDrop（多个掉落物）
create_pokemon_with_stats(
    name="MultiDrop",
    dex=10702,
    primary_type="fire",
    drop_items=[
        {"item": "minecraft:blaze_powder", "quantityRange": "0-1"},
        {"item": "cobblemon:charcoal_stick", "percentage": 5.0},
        {"item": "minecraft:coal", "quantityRange": "1-3", "percentage": 50.0}
    ],
    drop_amount=2
)
```

### Step 3: 完整配置测试
```python
# 测试宝可梦3：FullConfig（完整配置）
create_pokemon_with_stats(
    name="FullConfig",
    dex=10703,
    primary_type="grass",
    drop_items=[
        {"item": "cobblemon:exp_candy_xs", "percentage": 10.0},
        {"item": "minecraft:emerald", "percentage": 1.0}
    ],
    labels=["gen1", "starter", "custom"],
    egg_groups=["monster", "grass"],
    pokedex_key="cobblemon.species.fullconfig.desc"
)
```

---

## 📊 验证要点

### 游戏内检查：
1. ✅ `/reload` 无错误
2. ✅ 宝可梦能正常生成
3. ✅ 击败宝可梦后掉落正确物品
4. ✅ 掉落概率符合预期
5. ✅ 图鉴描述正确显示

---

## 📦 交付物

1. ✅ `tools/validators/drop_validator.py` - 掉落物验证器
2. ✅ `data/official_items.json` - 官方物品列表（Minecraft + Cobblemon）
3. ✅ `server.py` - 更新掉落物支持
4. ✅ `generate_v1.7.0_tests.py` - 测试脚本
5. ✅ `docs/design/V1.7.0_DESIGN.md` - 本设计文档
6. ✅ `README.md` - 更新文档
7. ✅ `CHANGELOG.md` - 更新日志

---

## 🔄 兼容性

- ✅ **向后兼容**：现有宝可梦不受影响（使用默认空掉落）
- ✅ **向前兼容**：生成的JSON格式与官方一致

---

## ⚠️ 已知限制

1. **物品验证**：仅验证原版Minecraft和Cobblemon物品，第三方模组物品会显示警告但不阻止
2. **掉落机制**：仅配置掉落列表，实际掉落逻辑由Cobblemon控制

---

## 📈 开发进度

- [x] 需求分析
- [ ] 创建掉落物验证器
- [ ] 导入官方物品数据
- [ ] 更新 server.py
- [ ] 创建测试脚本
- [ ] 游戏内验证
- [ ] 更新文档

