# v1.7.0 æ‰è½ç‰©å“ä¸æè¿°ç³»ç»Ÿ - è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**ï¼šæ”¯æŒå®å¯æ¢¦æ‰è½ç‰©å“é…ç½®å’Œå›¾é‰´æè¿°

**è¦†ç›–ç‡æå‡**ï¼š75% â†’ 82% (+7%)

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚åˆ†æ

### 1. æ‰è½ç‰©ç³»ç»Ÿï¼ˆDrops Systemï¼‰

#### å®˜æ–¹æ ¼å¼åˆ†æ

ä»å‚è€ƒåŒ…ï¼ˆcharmander.jsonï¼‰åˆ†æï¼Œå®˜æ–¹æ”¯æŒï¼š

```json
"drops": {
  "amount": 2,           // æ‰è½ç‰©å“æ•°é‡
  "entries": [            // æ‰è½æ¡ç›®åˆ—è¡¨
    {
      "item": "minecraft:blaze_powder",    // ç‰©å“ID
      "quantityRange": "0-1"               // æ•°é‡èŒƒå›´
    },
    {
      "item": "cobblemon:charcoal_stick",  // Cobblemonç‰©å“
      "percentage": 5.0                     // æ‰è½æ¦‚ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
    }
  ]
}
```

**å…³é”®å­—æ®µ**ï¼š
- `amount` - æ‰è½ç‰©å“æ•°é‡ï¼ˆæ•´æ•°ï¼‰
- `entries` - æ‰è½æ¡ç›®æ•°ç»„
- `item` - ç‰©å“IDï¼ˆæ”¯æŒ `minecraft:` å’Œ `cobblemon:` å‘½åç©ºé—´ï¼‰
- `quantityRange` - æ•°é‡èŒƒå›´ï¼ˆå­—ç¬¦ä¸²ï¼Œå¦‚ "0-1", "1-3"ï¼‰
- `percentage` - æ‰è½æ¦‚ç‡ï¼ˆæµ®ç‚¹æ•°ï¼Œ0-100ï¼‰

---

### 2. å›¾é‰´æè¿°ç³»ç»Ÿï¼ˆPokedex Descriptionï¼‰

#### å®˜æ–¹æ ¼å¼

```json
"pokedex": [
  "cobblemon.species.charmander.desc"
]
```

**ç‰¹ç‚¹**ï¼š
- ç¿»è¯‘é”®æ ¼å¼ï¼š`cobblemon.species.{å®å¯æ¢¦å}.desc`
- æ”¯æŒå¤šè¯­è¨€ï¼ˆéœ€é…åˆ lang æ–‡ä»¶ï¼‰

---

### 3. æ ‡ç­¾ç³»ç»Ÿï¼ˆLabelsï¼‰

```json
"labels": [
  "gen1",
  "starter",
  "custom"
]
```

**å¸¸ç”¨æ ‡ç­¾**ï¼š
- `gen1` - `gen8`ï¼šä¸–ä»£æ ‡ç­¾
- `starter`ï¼šå¾¡ä¸‰å®¶
- `legendary`ï¼šä¼ è¯´å®å¯æ¢¦
- `mythical`ï¼šå¹»ä¹‹å®å¯æ¢¦
- `custom`ï¼šè‡ªå®šä¹‰å®å¯æ¢¦

---

### 4. è›‹ç»„ç³»ç»Ÿï¼ˆEgg Groupsï¼‰

```json
"eggGroups": [
  "monster",
  "dragon"
]
```

**å®˜æ–¹è›‹ç»„**ï¼š
- `monster`ï¼šæ€ªå…½
- `water1`, `water2`, `water3`ï¼šæ°´ä¸­1ã€2ã€3
- `bug`ï¼šè™«
- `flying`ï¼šé£è¡Œ
- `field`ï¼šé™†ä¸Š
- `fairy`ï¼šå¦–ç²¾
- `grass`ï¼šæ¤ç‰©
- `human_like`ï¼šäººå‹
- `mineral`ï¼šçŸ¿ç‰©
- `amorphous`ï¼šä¸å®šå½¢
- `dragon`ï¼šé¾™
- `undiscovered`ï¼šæœªå‘ç°ï¼ˆä¸å¯ç”Ÿè›‹ï¼‰

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ‰è½ç‰©éªŒè¯å™¨ï¼ˆDropValidatorï¼‰

**è·¯å¾„**ï¼š`tools/validators/drop_validator.py`

**åŠŸèƒ½**ï¼š
```python
class DropValidator:
    """éªŒè¯æ‰è½ç‰©é…ç½®"""
    
    # Minecraft åŸç‰ˆç‰©å“
    MINECRAFT_ITEMS = [
        "stone", "cobblestone", "iron_ingot", "gold_ingot",
        "diamond", "emerald", "coal", "blaze_powder", ...
    ]
    
    # Cobblemon ç‰©å“
    COBBLEMON_ITEMS = [
        "poke_ball", "great_ball", "ultra_ball", "master_ball",
        "rare_candy", "exp_candy_xs", "charcoal_stick", ...
    ]
    
    @staticmethod
    def validate_item_id(item_id: str) -> tuple[bool, str]:
        """éªŒè¯ç‰©å“IDæ˜¯å¦æœ‰æ•ˆ"""
        if ":" not in item_id:
            return False, "ç‰©å“IDå¿…é¡»åŒ…å«å‘½åç©ºé—´ï¼ˆå¦‚ minecraft:stoneï¼‰"
        
        namespace, item_name = item_id.split(":", 1)
        
        if namespace == "minecraft":
            if item_name in DropValidator.MINECRAFT_ITEMS:
                return True, ""
            else:
                return False, f"æœªçŸ¥çš„Minecraftç‰©å“: {item_name}"
        elif namespace == "cobblemon":
            if item_name in DropValidator.COBBLEMON_ITEMS:
                return True, ""
            else:
                return False, f"æœªçŸ¥çš„Cobblemonç‰©å“: {item_name}"
        else:
            # å…è®¸å…¶ä»–æ¨¡ç»„çš„ç‰©å“ï¼ˆè­¦å‘Šä½†ä¸é˜»æ­¢ï¼‰
            return True, f"è­¦å‘Š: ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹æ¨¡ç»„ç‰©å“ {item_id}"
    
    @staticmethod
    def validate_quantity_range(range_str: str) -> tuple[bool, str]:
        """éªŒè¯æ•°é‡èŒƒå›´æ ¼å¼"""
        if "-" not in range_str:
            return False, "æ•°é‡èŒƒå›´æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º 'min-max' (å¦‚ '0-1', '1-3')"
        
        try:
            min_val, max_val = range_str.split("-")
            min_num = int(min_val)
            max_num = int(max_val)
            
            if min_num < 0 or max_num < 0:
                return False, "æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°"
            if min_num > max_num:
                return False, f"æœ€å°å€¼({min_num})ä¸èƒ½å¤§äºæœ€å¤§å€¼({max_num})"
            
            return True, ""
        except ValueError:
            return False, "æ•°é‡èŒƒå›´å¿…é¡»æ˜¯æ•´æ•°"
    
    @staticmethod
    def validate_percentage(percentage: float) -> tuple[bool, str]:
        """éªŒè¯æ‰è½æ¦‚ç‡"""
        if percentage < 0 or percentage > 100:
            return False, f"æ‰è½æ¦‚ç‡å¿…é¡»åœ¨0-100ä¹‹é—´ï¼Œå½“å‰å€¼: {percentage}"
        return True, ""
    
    @staticmethod
    def validate_drops(drops_config: dict) -> tuple[bool, list]:
        """éªŒè¯å®Œæ•´çš„æ‰è½ç‰©é…ç½®"""
        errors = []
        
        # éªŒè¯ amount
        amount = drops_config.get("amount", 0)
        if not isinstance(amount, int) or amount < 0:
            errors.append(f"amount å¿…é¡»æ˜¯éè´Ÿæ•´æ•°ï¼Œå½“å‰å€¼: {amount}")
        
        # éªŒè¯ entries
        entries = drops_config.get("entries", [])
        if not isinstance(entries, list):
            errors.append("entries å¿…é¡»æ˜¯åˆ—è¡¨")
            return False, errors
        
        for i, entry in enumerate(entries):
            # éªŒè¯ç‰©å“ID
            item_id = entry.get("item")
            if not item_id:
                errors.append(f"æ¡ç›® #{i+1}: ç¼ºå°‘ item å­—æ®µ")
                continue
            
            is_valid, msg = DropValidator.validate_item_id(item_id)
            if not is_valid:
                errors.append(f"æ¡ç›® #{i+1}: {msg}")
            
            # éªŒè¯æ•°é‡èŒƒå›´ï¼ˆå¯é€‰ï¼‰
            if "quantityRange" in entry:
                is_valid, msg = DropValidator.validate_quantity_range(entry["quantityRange"])
                if not is_valid:
                    errors.append(f"æ¡ç›® #{i+1}: {msg}")
            
            # éªŒè¯æ‰è½æ¦‚ç‡ï¼ˆå¯é€‰ï¼‰
            if "percentage" in entry:
                is_valid, msg = DropValidator.validate_percentage(entry["percentage"])
                if not is_valid:
                    errors.append(f"æ¡ç›® #{i+1}: {msg}")
        
        return len(errors) == 0, errors
```

---

### 2. server.py æ›´æ–°

**æ–°å¢å‚æ•°**ï¼š

```python
async def create_pokemon_with_stats(
    # ... ç°æœ‰å‚æ•° ...
    
    # v1.7.0: æ‰è½ç‰©ä¸æè¿°ç³»ç»Ÿ
    drop_items: list = None,          # ç®€åŒ–æ¥å£ï¼š[{"item": "minecraft:stone", "percentage": 5.0}]
    drop_amount: int = 1,              # æ‰è½ç‰©å“æ•°é‡
    labels: list = None,               # æ ‡ç­¾ï¼ˆå¦‚ ["gen1", "starter"]ï¼‰
    egg_groups: list = None,           # è›‹ç»„ï¼ˆå¦‚ ["monster", "dragon"]ï¼‰
    pokedex_key: str = None            # å›¾é‰´ç¿»è¯‘é”®ï¼ˆå¯é€‰ï¼Œé»˜è®¤è‡ªåŠ¨ç”Ÿæˆï¼‰
) -> dict:
```

**å¤„ç†é€»è¾‘**ï¼š

```python
# å¤„ç†æ‰è½ç‰©
if drop_items:
    from tools.validators.drop_validator import DropValidator
    
    drops_config = {
        "amount": drop_amount,
        "entries": []
    }
    
    for item_config in drop_items:
        # éªŒè¯ç‰©å“ID
        is_valid, msg = DropValidator.validate_item_id(item_config["item"])
        if not is_valid:
            return {"success": False, "error": msg}
        
        entry = {"item": item_config["item"]}
        
        # æ·»åŠ å¯é€‰å­—æ®µ
        if "quantityRange" in item_config:
            is_valid, msg = DropValidator.validate_quantity_range(item_config["quantityRange"])
            if not is_valid:
                return {"success": False, "error": msg}
            entry["quantityRange"] = item_config["quantityRange"]
        
        if "percentage" in item_config:
            is_valid, msg = DropValidator.validate_percentage(item_config["percentage"])
            if not is_valid:
                return {"success": False, "error": msg}
            entry["percentage"] = item_config["percentage"]
        
        drops_config["entries"].append(entry)
    
    species["drops"] = drops_config
else:
    # é»˜è®¤ç©ºæ‰è½
    species["drops"] = {"amount": 1, "entries": []}

# å¤„ç†å›¾é‰´æè¿°
if pokedex_key:
    species["pokedex"] = [pokedex_key]
else:
    species["pokedex"] = [f"cobblemon.species.{name.lower()}.desc"]

# å¤„ç†æ ‡ç­¾
if labels:
    species["labels"] = labels
else:
    species["labels"] = ["custom"]

# å¤„ç†è›‹ç»„
if egg_groups:
    species["eggGroups"] = egg_groups
else:
    species["eggGroups"] = ["undiscovered"]
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥ï¼ˆæ¸è¿›å¼ï¼‰

### Step 1: åŸºç¡€æ‰è½ç‰©æµ‹è¯•
```python
# æµ‹è¯•å®å¯æ¢¦1ï¼šSimpleDropï¼ˆå•ä¸ªæ‰è½ç‰©ï¼‰
create_pokemon_with_stats(
    name="SimpleDrop",
    dex=10701,
    primary_type="normal",
    drop_items=[
        {"item": "minecraft:stone", "percentage": 100.0}
    ]
)
```

### Step 2: å¤šæ‰è½ç‰©æµ‹è¯•
```python
# æµ‹è¯•å®å¯æ¢¦2ï¼šMultiDropï¼ˆå¤šä¸ªæ‰è½ç‰©ï¼‰
create_pokemon_with_stats(
    name="MultiDrop",
    dex=10702,
    primary_type="fire",
    drop_items=[
        {"item": "minecraft:blaze_powder", "quantityRange": "0-1"},
        {"item": "cobblemon:charcoal_stick", "percentage": 5.0},
        {"item": "minecraft:coal", "quantityRange": "1-3", "percentage": 50.0}
    ],
    drop_amount=2
)
```

### Step 3: å®Œæ•´é…ç½®æµ‹è¯•
```python
# æµ‹è¯•å®å¯æ¢¦3ï¼šFullConfigï¼ˆå®Œæ•´é…ç½®ï¼‰
create_pokemon_with_stats(
    name="FullConfig",
    dex=10703,
    primary_type="grass",
    drop_items=[
        {"item": "cobblemon:exp_candy_xs", "percentage": 10.0},
        {"item": "minecraft:emerald", "percentage": 1.0}
    ],
    labels=["gen1", "starter", "custom"],
    egg_groups=["monster", "grass"],
    pokedex_key="cobblemon.species.fullconfig.desc"
)
```

---

## ğŸ“Š éªŒè¯è¦ç‚¹

### æ¸¸æˆå†…æ£€æŸ¥ï¼š
1. âœ… `/reload` æ— é”™è¯¯
2. âœ… å®å¯æ¢¦èƒ½æ­£å¸¸ç”Ÿæˆ
3. âœ… å‡»è´¥å®å¯æ¢¦åæ‰è½æ­£ç¡®ç‰©å“
4. âœ… æ‰è½æ¦‚ç‡ç¬¦åˆé¢„æœŸ
5. âœ… å›¾é‰´æè¿°æ­£ç¡®æ˜¾ç¤º

---

## ğŸ“¦ äº¤ä»˜ç‰©

1. âœ… `tools/validators/drop_validator.py` - æ‰è½ç‰©éªŒè¯å™¨
2. âœ… `data/official_items.json` - å®˜æ–¹ç‰©å“åˆ—è¡¨ï¼ˆMinecraft + Cobblemonï¼‰
3. âœ… `server.py` - æ›´æ–°æ‰è½ç‰©æ”¯æŒ
4. âœ… `generate_v1.7.0_tests.py` - æµ‹è¯•è„šæœ¬
5. âœ… `docs/design/V1.7.0_DESIGN.md` - æœ¬è®¾è®¡æ–‡æ¡£
6. âœ… `README.md` - æ›´æ–°æ–‡æ¡£
7. âœ… `CHANGELOG.md` - æ›´æ–°æ—¥å¿—

---

## ğŸ”„ å…¼å®¹æ€§

- âœ… **å‘åå…¼å®¹**ï¼šç°æœ‰å®å¯æ¢¦ä¸å—å½±å“ï¼ˆä½¿ç”¨é»˜è®¤ç©ºæ‰è½ï¼‰
- âœ… **å‘å‰å…¼å®¹**ï¼šç”Ÿæˆçš„JSONæ ¼å¼ä¸å®˜æ–¹ä¸€è‡´

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **ç‰©å“éªŒè¯**ï¼šä»…éªŒè¯åŸç‰ˆMinecraftå’ŒCobblemonç‰©å“ï¼Œç¬¬ä¸‰æ–¹æ¨¡ç»„ç‰©å“ä¼šæ˜¾ç¤ºè­¦å‘Šä½†ä¸é˜»æ­¢
2. **æ‰è½æœºåˆ¶**ï¼šä»…é…ç½®æ‰è½åˆ—è¡¨ï¼Œå®é™…æ‰è½é€»è¾‘ç”±Cobblemonæ§åˆ¶

---

## ğŸ“ˆ å¼€å‘è¿›åº¦

- [x] éœ€æ±‚åˆ†æ
- [ ] åˆ›å»ºæ‰è½ç‰©éªŒè¯å™¨
- [ ] å¯¼å…¥å®˜æ–¹ç‰©å“æ•°æ®
- [ ] æ›´æ–° server.py
- [ ] åˆ›å»ºæµ‹è¯•è„šæœ¬
- [ ] æ¸¸æˆå†…éªŒè¯
- [ ] æ›´æ–°æ–‡æ¡£

