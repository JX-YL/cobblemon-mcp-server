# V1.8.0 设计文档 - 生成系统（Spawn System）

## 📅 版本信息
- **版本**: v1.8.0
- **日期**: 2025-10-28
- **主题**: 宝可梦生成配置系统

---

## 🎯 设计目标

### 核心功能
1. **生成池配置** - 完整的 `spawn_pool_world` 文件生成
2. **多条件生成** - 支持生物群系、光照、天气等条件
3. **稀有度控制** - common, uncommon, rare, ultra-rare
4. **动态权重** - 支持条件权重乘数

### 设计原则
- 100% 兼容官方 Cobblemon spawn 格式
- 支持多个生成条目（一个宝可梦可以有多个生成配置）
- 渐进式复杂度（从简单到复杂）
- 完整的验证和错误提示

---

## 📊 官方格式分析

### 1. 顶层结构
```json
{
    "enabled": true,
    "neededInstalledMods": [],
    "neededUninstalledMods": [],
    "spawns": [...]
}
```

### 2. 单个 Spawn 配置
```json
{
    "id": "charmander-1",
    "pokemon": "charmander",
    "presets": ["natural"],
    "type": "pokemon",
    "context": "grounded",
    "bucket": "ultra-rare",
    "level": "5-31",
    "weight": 6.0,
    "condition": {...},
    "anticondition": {...},
    "weightMultiplier": {...}
}
```

### 3. 关键字段说明

#### 必需字段
- **id**: 唯一标识符（string）
- **pokemon**: 宝可梦名称（string）
  - 基础格式: `"charmander"`
  - 带参数: `"pikachu region_bias=alola"`
- **type**: 固定为 `"pokemon"`（string）
- **context**: 生成上下文（string）
  - `grounded` - 地面
  - `surface` - 水面
  - `submerged` - 水下
  - `seafloor` - 海底
- **bucket**: 稀有度（string）
  - `common` - 常见
  - `uncommon` - 不常见
  - `rare` - 稀有
  - `ultra-rare` - 超稀有
- **level**: 等级范围（string）
  - 格式: `"5-31"`, `"1-100"` 等
- **weight**: 权重（float）
  - 影响生成概率
  - 范围: 0.1 - 100.0

#### 可选字段
- **presets**: 预设列表（list of string）
  - `["natural"]` - 自然生成
  - `["mansion"]` - 豪宅生成
  - 默认: `["natural"]`
- **condition**: 生成条件（dict）
- **anticondition**: 反条件（dict）
- **weightMultiplier**: 条件权重乘数（dict）

### 4. Condition 字段

#### 光照条件
- **minSkyLight**: 最小天空光照（int, 0-15）
- **maxSkyLight**: 最大天空光照（int, 0-15）
- **minBlockLight**: 最小方块光照（int, 0-15）
- **maxBlockLight**: 最大方块光照（int, 0-15）

#### 生物群系条件
- **biomes**: 生物群系列表（list of string）
  - 支持标签: `"#cobblemon:is_forest"`
  - 支持具体群系: `"minecraft:plains"`
  - 支持模组群系: `"aether:skyroot_forest"`

#### 天气条件
- **isRaining**: 是否下雨（boolean）
- **isThundering**: 是否打雷（boolean）

#### 其他条件
- **canSeeSky**: 能否看到天空（boolean）
- **isSlimeChunk**: 是否史莱姆区块（boolean）
- **minY**: 最小Y坐标（int）
- **maxY**: 最大Y坐标（int）
- **timeRange**: 时间范围（string）
  - 格式: `"day"`, `"night"`, `"dawn"`, `"dusk"`

### 5. WeightMultiplier（条件权重乘数）
```json
{
    "multiplier": 5.0,
    "condition": {
        "isThundering": true
    }
}
```

### 6. AntiCondition（反条件）
```json
{
    "biomes": [
        "#cobblemon:is_ocean"
    ]
}
```

---

## 🚀 实现方案

### Phase 1: 基础生成配置（Step 1）

#### 测试宝可梦 1: SimpleSpawn
- **目标**: 最简单的生成配置
- **配置**:
  - 单个 spawn 条目
  - 基础字段: id, pokemon, type, context, bucket, level, weight
  - 简单条件: 生物群系

```python
{
    "enabled": true,
    "spawns": [
        {
            "id": "simplespawn-1",
            "pokemon": "simplespawn",
            "presets": ["natural"],
            "type": "pokemon",
            "context": "grounded",
            "bucket": "common",
            "level": "5-30",
            "weight": 10.0,
            "condition": {
                "biomes": ["#cobblemon:is_plains"]
            }
        }
    ]
}
```

#### 测试宝可梦 2: RareSpawn
- **目标**: 稀有生成
- **新增**: 
  - 稀有度设置
  - 光照条件

```python
{
    "id": "rarespawn-1",
    "bucket": "ultra-rare",
    "weight": 6.0,
    "condition": {
        "minSkyLight": 8,
        "maxSkyLight": 15,
        "biomes": ["#cobblemon:is_hills"]
    }
}
```

### Phase 2: 天气与时间条件（Step 2）

#### 测试宝可梦 3: WeatherSpawn
- **目标**: 天气条件生成
- **新增**:
  - 天气条件
  - 权重乘数

```python
{
    "id": "weatherspawn-1",
    "bucket": "uncommon",
    "weight": 0.712,
    "weightMultiplier": {
        "multiplier": 5.0,
        "condition": {
            "isThundering": true
        }
    },
    "condition": {
        "biomes": ["#cobblemon:is_forest"],
        "isRaining": false
    }
}
```

#### 测试宝可梦 4: NightSpawn
- **目标**: 夜间生成
- **新增**:
  - 时间范围
  - Y坐标限制

```python
{
    "id": "nightspawn-1",
    "bucket": "uncommon",
    "level": "10-40",
    "weight": 8.0,
    "condition": {
        "timeRange": "night",
        "minY": 60,
        "maxY": 120,
        "biomes": ["#cobblemon:is_overworld"]
    }
}
```

### Phase 3: 多条目与反条件（Step 3）

#### 测试宝可梦 5: MultiSpawn
- **目标**: 多个生成条目
- **新增**:
  - 同一宝可梦的多个生成配置
  - 反条件

```python
{
    "spawns": [
        {
            "id": "multispawn-1",
            "context": "grounded",
            "bucket": "common",
            "condition": {
                "biomes": ["#cobblemon:is_forest"]
            }
        },
        {
            "id": "multispawn-2",
            "context": "surface",
            "bucket": "uncommon",
            "condition": {
                "biomes": ["#cobblemon:is_river"]
            },
            "anticondition": {
                "biomes": ["#cobblemon:is_ocean"]
            }
        },
        {
            "id": "multispawn-3",
            "context": "submerged",
            "bucket": "rare",
            "condition": {
                "biomes": ["#cobblemon:is_ocean"],
                "minY": 30,
                "maxY": 60
            }
        }
    ]
}
```

### Phase 4: 完整配置（Step 4）

#### 测试宝可梦 6: FullSpawn
- **目标**: 所有功能综合
- **配置**:
  - 多个生成条目
  - 完整的条件组合
  - 权重乘数
  - 反条件
  - 特殊条件（canSeeSky, isSlimeChunk）

```python
{
    "spawns": [
        {
            "id": "fullspawn-1",
            "pokemon": "fullspawn",
            "presets": ["natural"],
            "type": "pokemon",
            "context": "grounded",
            "bucket": "rare",
            "level": "20-50",
            "weight": 12.0,
            "weightMultiplier": {
                "multiplier": 3.0,
                "condition": {
                    "isThundering": true
                }
            },
            "condition": {
                "minSkyLight": 8,
                "maxSkyLight": 15,
                "biomes": [
                    "#cobblemon:is_mountains",
                    "#cobblemon:is_hills"
                ],
                "timeRange": "day",
                "minY": 80,
                "maxY": 200
            },
            "anticondition": {
                "biomes": [
                    "#cobblemon:is_cold"
                ]
            }
        },
        {
            "id": "fullspawn-2",
            "pokemon": "fullspawn",
            "presets": ["natural"],
            "type": "pokemon",
            "context": "grounded",
            "bucket": "ultra-rare",
            "level": "20-50",
            "weight": 6.0,
            "condition": {
                "canSeeSky": false,
                "isSlimeChunk": true,
                "biomes": ["#cobblemon:is_overworld"],
                "minY": 0,
                "maxY": 40
            }
        }
    ]
}
```

---

## 🔧 技术实现

### 1. SpawnValidator（验证器）

#### 验证项
- ✅ **基础字段验证**
  - id 唯一性
  - pokemon 名称格式
  - context 枚举值
  - bucket 枚举值
  - level 格式验证
  - weight 范围验证
  
- ✅ **条件验证**
  - 光照值范围（0-15）
  - Y坐标范围（-64 - 320）
  - 生物群系标签格式
  - 时间范围枚举值
  
- ✅ **逻辑验证**
  - min/max 大小关系
  - 条件组合合理性

#### 错误提示
- 字段缺失提示
- 值范围提示
- 格式错误提示
- 拼写建议

### 2. BiomeValidator（生物群系验证）

#### 常见生物群系标签
```python
COMMON_BIOME_TAGS = [
    "#cobblemon:is_plains",
    "#cobblemon:is_forest",
    "#cobblemon:is_hills",
    "#cobblemon:is_mountains",
    "#cobblemon:is_ocean",
    "#cobblemon:is_river",
    "#cobblemon:is_beach",
    "#cobblemon:is_volcanic",
    "#cobblemon:is_cold",
    "#cobblemon:is_freezing",
    "#cobblemon:is_spooky",
    "#cobblemon:is_overworld",
    "#cobblemon:is_nether",
    "#cobblemon:is_end",
    "#cobblemon:is_tropical_island"
]
```

### 3. 参数设计

#### server.py 新增参数
```python
async def create_pokemon_with_stats(
    # ... 现有参数 ...
    
    # v1.8.0: 生成系统
    spawns: list = None,              # 生成配置列表
    spawn_enabled: bool = True,       # 是否启用生成
) -> dict:
```

#### spawns 参数格式
```python
spawns = [
    {
        # 必需字段
        "id": "pokemon-1",
        "context": "grounded",
        "bucket": "common",
        "level": "5-30",
        "weight": 10.0,
        
        # 可选字段
        "presets": ["natural"],
        "condition": {
            "biomes": ["#cobblemon:is_plains"],
            "minSkyLight": 8,
            "maxSkyLight": 15,
            "isRaining": False,
            "timeRange": "day"
        },
        "anticondition": {
            "biomes": ["#cobblemon:is_ocean"]
        },
        "weightMultiplier": {
            "multiplier": 5.0,
            "condition": {
                "isThundering": True
            }
        }
    }
]
```

### 4. 文件生成

#### 文件路径
```
output/
  PokemonName/
    data/
      cobblemon/
        species/
          pokemonname.json
        spawn_pool_world/
          pokemonname.json    # 新增
    pack.mcmeta
```

---

## 📦 测试策略

### Step 1: 基础生成（SimpleSpawn, RareSpawn）
- 验证文件生成
- 验证基础字段
- 验证生物群系条件

### Step 2: 天气时间（WeatherSpawn, NightSpawn）
- 验证天气条件
- 验证时间范围
- 验证权重乘数

### Step 3: 多条目（MultiSpawn）
- 验证多个生成配置
- 验证反条件
- 验证不同 context

### Step 4: 完整配置（FullSpawn）
- 验证所有功能组合
- 游戏内生成测试
- 稀有度测试

### 游戏内测试方法
1. 使用 `/reload` 重载数据包
2. 前往对应生物群系
3. 使用 `/pokespawn` 查看生成信息
4. 等待自然生成或使用命令测试

---

## 📊 覆盖率提升

### v1.7.0 → v1.8.0
- **v1.7.0**: 82% 覆盖率
- **v1.8.0**: **88% 覆盖率** (+6%)

### 新增支持项
- ✅ 生成池配置（spawn_pool_world）
- ✅ 8+ 种生成条件
- ✅ 4 种稀有度等级
- ✅ 4 种生成上下文
- ✅ 条件权重乘数
- ✅ 反条件系统

---

## 🎯 成功标准

### 功能完整性
- ✅ 支持所有官方 spawn 字段
- ✅ 100% 格式兼容
- ✅ 完整的验证系统

### 易用性
- ✅ 清晰的参数设计
- ✅ 详细的错误提示
- ✅ 丰富的示例

### 测试覆盖
- ✅ 6 个测试宝可梦
- ✅ 渐进式测试
- ✅ 游戏内验证

---

## 📝 文档要求

- ✅ V1.8.0_DESIGN.md - 本设计文档
- ✅ V1.8.0_TEST_GUIDE.md - 测试指南
- ✅ V1.8.0_QUICK_COMMANDS.md - 快速测试指令
- ✅ 更新 README.md 和 CHANGELOG.md

