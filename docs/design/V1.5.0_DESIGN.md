# v1.5.0 设计文档 - 性别/性格/生物群系进化

**版本号**: v1.5.0  
**开发时间**: 2025-10-24  
**主题**: 性别与性格进化、生物群系进化

---

## 📋 版本目标

基于参考包的覆盖率报告，v1.5.0 将实现以下高级进化机制：

1. ✅ **properties (gender)** - 性别条件进化
2. ✅ **properties (nature)** - 性格条件进化  
3. ✅ **biome** - 生物群系条件进化
4. ✅ **damage_taken** - 伤害条件进化

---

## 🎯 参考包分析

### 已实现的进化机制（覆盖率 97%）

参考包 Instance Package 实现了 **10 种进化机制**：

| 进化机制 | MCP支持状态 | 参考示例 |
|---------|------------|---------|
| level_up | ✅ v1.3.0 | Machop → Machoke |
| item_interact | ✅ v1.3.0 | Eevee → Flareon (fire_stone) |
| trade | ✅ v1.3.0 | Machoke → Machamp |
| friendship | ✅ v1.3.0 | Pichu → Pikachu |
| time_range | ✅ v1.3.0 | Rockruff (day/night/dusk) |
| has_move_type | ✅ v1.3.0 | Eevee → Sylveon (fairy move) |
| **properties (gender)** | ❌ **v1.5.0新增** | **Salandit → Salazzle (female only)** |
| **properties (nature)** | ❌ **v1.5.0新增** | **Toxel → Toxtricity (25 natures)** |
| **biome** | ❌ **v1.5.0新增** | **Petilil → Lilligant (regional)** |
| **damage_taken** | ❌ **v1.5.0新增** | **Yamask-Galar → Runerigus (49 damage)** |

---

## 🔍 官方格式分析

### 1. properties (gender) - 性别条件

**示例：Salandit (#757) - 只有雌性可以进化**

```json
{
  "id": "salandit_salazzle",
  "variant": "level_up",
  "result": "salazzle",
  "consumeHeldItem": false,
  "learnableMoves": ["captivate", "firelash"],
  "requirements": [
    {
      "variant": "level",
      "minLevel": 33
    },
    {
      "variant": "properties",
      "target": "gender=female"
    }
  ]
}
```

**关键字段**：
- `variant`: "properties"
- `target`: "gender=female" 或 "gender=male"

---

### 2. properties (nature) - 性格条件

**示例：Toxel (#848) - 25种性格对应2种形态**

```json
{
  "id": "toxelhardy_toxtricity",
  "variant": "level_up",
  "result": "toxtricity punk_form=amped",  // 高调形态
  "requirements": [
    {
      "variant": "level",
      "minLevel": 30
    },
    {
      "variant": "properties",
      "target": "toxel nature=hardy"  // 指定性格
    }
  ]
}
```

**性格分类**（Toxel案例）：

**Amped Form（高调）**：13种性格
```
hardy, brave, adamant, naughty, docile, impish, lax, 
hasty, jolly, naive, rash, sassy, quirky
```

**Low Key Form（低调）**：12种性格
```
lonely, bold, relaxed, timid, serious, modest, mild, 
quiet, bashful, calm, gentle, careful
```

**关键字段**：
- `variant`: "properties"
- `target`: "pokemonname nature=naturename" 格式

---

### 3. biome - 生物群系条件

**示例：Petilil (#548) - 地区形态进化**

```json
{
  "id": "petilil_lilliganthisui",
  "variant": "item_interact",
  "result": "lilligant hisuian",
  "requiredContext": "cobblemon:sun_stone",
  "requirements": [
    {
      "variant": "biome",
      "biomeCondition": "#cobblemon:evolution/regional/petilil_hisuibiome"
    }
  ]
}
```

**关键字段**：
- `variant`: "biome"
- `biomeCondition`: 生物群系标签（以 `#cobblemon:` 开头）

**常见生物群系条件**：
```
#cobblemon:evolution/regional/petilil_hisuibiome    # 洗翠地区
#cobblemon:evolution/regional/petilil_unovabiome    # 合众地区
#cobblemon:is_sandy                                 # 沙漠
#cobblemon:is_snowy                                 # 雪地
#cobblemon:is_ocean                                 # 海洋
```

---

### 4. damage_taken - 伤害条件

**示例：Yamask-Galar (#562) - 受到伤害后进化**

```json
{
  "id": "yamask_runerigus",
  "variant": "level_up",
  "result": "runerigus",
  "requirements": [
    {
      "variant": "level",
      "minLevel": 0  // 任意等级
    },
    {
      "variant": "damage_taken",
      "amount": 49  // 受到49点伤害
    },
    {
      "variant": "biome",
      "biomeCondition": "#cobblemon:is_sandy"  // 在沙漠中
    }
  ]
}
```

**关键字段**：
- `variant`: "damage_taken"
- `amount`: 伤害值（整数）

---

## 🛠️ 实现方案

### 1. 验证器扩展

#### 新增文件：`tools/validators/properties_validator.py`

```python
class PropertiesValidator:
    """验证 properties 条件（性别、性格等）"""
    
    SUPPORTED_GENDERS = ["male", "female"]
    
    SUPPORTED_NATURES = [
        "hardy", "lonely", "brave", "adamant", "naughty",
        "bold", "docile", "relaxed", "impish", "lax",
        "timid", "hasty", "serious", "jolly", "naive",
        "modest", "mild", "quiet", "bashful", "rash",
        "calm", "gentle", "sassy", "careful", "quirky"
    ]
    
    @staticmethod
    def validate_gender_condition(target: str):
        """验证性别条件"""
        if not target.startswith("gender="):
            return False, "性别条件必须以 'gender=' 开头"
        
        gender = target.split("=")[1]
        if gender not in PropertiesValidator.SUPPORTED_GENDERS:
            return False, f"不支持的性别: {gender}"
        
        return True, None
    
    @staticmethod
    def validate_nature_condition(target: str):
        """验证性格条件"""
        if " nature=" not in target:
            return False, "性格条件必须包含 ' nature='"
        
        parts = target.split(" nature=")
        if len(parts) != 2:
            return False, "性格条件格式错误"
        
        pokemon_name, nature = parts
        if nature not in PropertiesValidator.SUPPORTED_NATURES:
            return False, f"不支持的性格: {nature}"
        
        return True, None
```

#### 新增文件：`tools/validators/biome_validator.py`

```python
class BiomeValidator:
    """验证生物群系条件"""
    
    COMMON_BIOMES = [
        "#cobblemon:is_sandy",
        "#cobblemon:is_snowy",
        "#cobblemon:is_ocean",
        "#cobblemon:is_forest",
        "#cobblemon:is_mountain",
        "#cobblemon:is_plains",
        "#cobblemon:evolution/regional/petilil_hisuibiome",
        "#cobblemon:evolution/regional/petilil_unovabiome"
    ]
    
    @staticmethod
    def validate_biome_condition(biome_condition: str):
        """验证生物群系条件"""
        if not biome_condition.startswith("#"):
            return False, "生物群系标签必须以 '#' 开头"
        
        if not biome_condition.startswith("#cobblemon:"):
            return False, "生物群系标签必须以 '#cobblemon:' 开头"
        
        return True, None
```

#### 新增文件：`tools/validators/damage_validator.py`

```python
class DamageValidator:
    """验证伤害条件"""
    
    @staticmethod
    def validate_damage_amount(amount: int):
        """验证伤害值"""
        if not isinstance(amount, int):
            return False, "伤害值必须是整数"
        
        if amount <= 0:
            return False, "伤害值必须大于0"
        
        if amount > 1000:
            return False, "伤害值不能超过1000"
        
        return True, None
```

---

### 2. server.py 功能扩展

#### 新增参数（create_pokemon_with_stats）

```python
@mcp.tool()
async def create_pokemon_with_stats(
    # ... 现有参数 ...
    
    # v1.5.0: 性别与性格进化
    evolution_gender: str = None,          # 性别条件: "male" 或 "female"
    evolution_nature: str = None,          # 性格条件: "hardy", "brave" 等
    
    # v1.5.0: 生物群系进化
    evolution_biome: str = None,           # 生物群系: "#cobblemon:is_sandy" 等
    
    # v1.5.0: 伤害条件进化
    evolution_damage_amount: int = None,   # 伤害值: 49 等
    
) -> dict:
    """创建宝可梦配置（v1.5.0 - 支持性别/性格/生物群系/伤害进化）"""
```

#### 进化构建逻辑更新

```python
# v1.5.0: 性别条件
if evolution_gender:
    valid, error = PropertiesValidator.validate_gender_condition(f"gender={evolution_gender}")
    if not valid:
        raise ValueError(f"性别条件无效: {error}")
    
    requirements.append({
        "variant": "properties",
        "target": f"gender={evolution_gender}"
    })

# v1.5.0: 性格条件
if evolution_nature:
    target = f"{name.lower()} nature={evolution_nature}"
    valid, error = PropertiesValidator.validate_nature_condition(target)
    if not valid:
        raise ValueError(f"性格条件无效: {error}")
    
    requirements.append({
        "variant": "properties",
        "target": target
    })

# v1.5.0: 生物群系条件
if evolution_biome:
    valid, error = BiomeValidator.validate_biome_condition(evolution_biome)
    if not valid:
        raise ValueError(f"生物群系条件无效: {error}")
    
    requirements.append({
        "variant": "biome",
        "biomeCondition": evolution_biome
    })

# v1.5.0: 伤害条件
if evolution_damage_amount:
    valid, error = DamageValidator.validate_damage_amount(evolution_damage_amount)
    if not valid:
        raise ValueError(f"伤害条件无效: {error}")
    
    requirements.append({
        "variant": "damage_taken",
        "amount": evolution_damage_amount
    })
```

---

## 📝 使用示例

### 示例 1: 性别条件进化（Salandit）

```python
# 焰后蜥 - 只有雌性可以进化
await create_complete_package(
    name="Salandit",
    dex=757,
    primary_type="poison",
    secondary_type="fire",
    male_ratio=0.875,  # 87.5% 雄性（很多雄性无法进化）
    hp=48, attack=44, defence=40,
    special_attack=71, special_defence=40, speed=77,
    
    # v1.5.0: 性别条件进化
    evolution_target="Salazzle",
    evolution_variant="level_up",
    evolution_level=33,
    evolution_gender="female"  # ✨ 只有雌性可以进化
)
```

### 示例 2: 性格条件进化（Toxel）

```python
# 毒电婴 - 高调形态（Hardy性格）
await create_complete_package(
    name="Toxel",
    dex=848,
    primary_type="electric",
    secondary_type="poison",
    hp=40, attack=38, defence=35,
    special_attack=54, special_defence=35, speed=40,
    
    # v1.5.0: 性格条件进化
    evolution_target="Toxtricity",
    evolution_variant="level_up",
    evolution_level=30,
    evolution_nature="hardy"  # ✨ Hardy性格 → 高调形态
)
```

### 示例 3: 生物群系条件进化（Petilil）

```python
# 花蓓蓓 - 洗翠形态
await create_complete_package(
    name="Petilil",
    dex=548,
    primary_type="grass",
    male_ratio=0.0,  # 100% 雌性
    hp=45, attack=35, defence=50,
    special_attack=70, special_defence=50, speed=30,
    
    # v1.5.0: 生物群系条件进化
    evolution_target="Lilligant",
    evolution_variant="item_interact",
    evolution_item="cobblemon:sun_stone",
    evolution_biome="#cobblemon:evolution/regional/petilil_hisuibiome"  # ✨ 洗翠地区
)
```

### 示例 4: 伤害条件进化（Yamask-Galar）

```python
# 哭哭面具（伽勒尔） - 受伤后进化
await create_complete_package(
    name="Yamask",
    dex=562,
    primary_type="ground",
    secondary_type="ghost",
    hp=38, attack=55, defence=85,
    special_attack=30, special_defence=65, speed=30,
    
    # v1.5.0: 伤害 + 生物群系复合条件
    evolution_target="Runerigus",
    evolution_variant="level_up",
    evolution_level=0,  # 任意等级
    evolution_damage_amount=49,  # ✨ 受到49点伤害
    evolution_biome="#cobblemon:is_sandy"  # ✨ 在沙漠中
)
```

---

## 🎮 测试计划

### 测试包生成

创建以下测试包：

1. **Salandit → Salazzle** - 性别条件
2. **Toxel → Toxtricity** - 性格条件（2种形态）
3. **Petilil → Lilligant** - 生物群系条件（2种形态）
4. **Yamask → Runerigus** - 伤害 + 生物群系复合条件

### 验证清单

- [ ] 性别条件正确验证
- [ ] 性格条件支持25种性格
- [ ] 生物群系标签格式正确
- [ ] 伤害值合理范围
- [ ] 复合条件正确组合
- [ ] JSON格式符合官方规范

---

## 📊 覆盖率提升

| 版本 | 覆盖率 | 新增功能 |
|------|-------|---------|
| v1.3.0 | 60% | 基础进化（level_up, item_interact, trade, friendship, time_range, has_move_type） |
| v1.4.1 | 65% | 基础字段扩展（双属性、性别比例、努力值等）|
| **v1.5.0** | **85%** | **性别/性格/生物群系/伤害进化** |

**新增覆盖**：
- ✅ properties (gender)
- ✅ properties (nature)
- ✅ biome
- ✅ damage_taken

---

## 🔄 版本兼容性

### 向后兼容
- ✅ 完全兼容 v1.4.1 及之前版本
- ✅ 所有现有功能保持不变
- ✅ 新参数为可选参数

### Cobblemon 兼容
- ✅ Cobblemon 1.5.0+
- ✅ Minecraft 1.20.1+

---

## 📚 文档更新

需要更新的文档：
1. `README.md` - 添加 v1.5.0 功能说明
2. `CHANGELOG.md` - 记录 v1.5.0 更新
3. `docs/examples/` - 添加 v1.5.0 示例脚本

---

## 🎯 开发里程碑

- [x] 需求分析（参考包分析）
- [ ] 验证器实现（PropertiesValidator, BiomeValidator, DamageValidator）
- [ ] server.py 功能扩展
- [ ] EvolutionValidator 更新
- [ ] 测试包生成
- [ ] 文档更新
- [ ] 发布 v1.5.0

---

**设计完成日期**: 2025-10-24  
**预计发布日期**: 2025-10-24

