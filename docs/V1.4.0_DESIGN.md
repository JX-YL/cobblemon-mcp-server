# v1.4.0 设计文档：基础字段扩展

## 📋 版本概述

**版本号**: v1.4.0  
**主题**: 基础字段扩展  
**目标**: 提升 MCP 覆盖率从 45% 到 65%

## 🎯 功能优先级

根据使用率和重要性分析，v1.4.0 将实现以下高优先级字段：

### 第一批：核心字段（⭐⭐⭐）

| 字段 | 使用率 | 重要性 | 优先级 |
|------|--------|--------|--------|
| `secondaryType` | 60% | ⭐⭐⭐ | P0 |
| `maleRatio` | 95% | ⭐⭐⭐ | P0 |
| `catchRate` | 100% | ⭐⭐⭐ | P0 |
| `baseFriendship` | 100% | ⭐⭐⭐ | P0 |
| `evYield` | 100% | ⭐⭐⭐ | P0 |
| `abilities` | 100% | ⭐⭐⭐ | P0 |

### 第二批：辅助字段（⭐⭐）

| 字段 | 使用率 | 重要性 | 优先级 |
|------|--------|--------|--------|
| `height` | 100% | ⭐⭐ | P1 |
| `weight` | 100% | ⭐⭐ | P1 |
| `eggCycles` | 100% | ⭐⭐ | P1 |
| `baseScale` | 100% | ⭐⭐ | P1 |
| `hitbox` | 100% | ⭐⭐ | P1 |
| `drops` | 80% | ⭐⭐ | P1 |

### 第三批：优化字段

| 字段 | 当前状态 | 目标状态 |
|------|---------|---------|
| `eggGroups` | 固定 "undiscovered" | 支持 15 种生蛋组 |
| `baseExperienceYield` | 固定 64 | 根据阶段动态计算 |
| `experienceGroup` | 固定 "medium_slow" | 支持 6 种经验组 |

## 🔧 实现方案

### 1. secondaryType（双属性）

**默认值**: `None` (单属性)

**参数**:
```python
secondary_type: str = None  # "poison", "flying", etc.
```

**验证规则**:
- 必须是有效的属性类型
- 不能与 primary_type 相同

**JSON 结构**:
```json
{
  "primaryType": "electric",
  "secondaryType": "poison"  // 可选
}
```

### 2. abilities（特性系统）

**当前问题**: 固定为 `["overgrow"]`

**改进方案**:
```python
abilities: List[str] = None  # ["overgrow", "chlorophyll", "h:solar_power"]
```

**支持格式**:
- 普通特性: `"overgrow"`
- 隐藏特性: `"h:solar_power"`

**默认值**:
- 如果未指定，生成默认特性（基于属性）

**JSON 结构**:
```json
{
  "abilities": [
    "overgrow",
    "chlorophyll",
    "h:solar_power"
  ]
}
```

### 3. evYield（努力值）

**参数**:
```python
ev_hp: int = 0
ev_attack: int = 0
ev_defence: int = 0
ev_special_attack: int = 0
ev_special_defence: int = 0
ev_speed: int = 0
```

**验证规则**:
- 每个值：0-3
- 总和：最多 3

**JSON 结构**:
```json
{
  "evYield": {
    "hp": 0,
    "attack": 1,
    "defence": 0,
    "special_attack": 2,
    "special_defence": 0,
    "speed": 0
  }
}
```

### 4. maleRatio（性别比例）

**参数**:
```python
male_ratio: float = 0.5  # 0.0 = 全雌, 0.5 = 50/50, 1.0 = 全雄, -1 = 无性别
```

**特殊值**:
- `-1`: 无性别（如超梦、未知图腾）

**验证规则**:
- 值范围：-1 或 0.0-1.0

**JSON 结构**:
```json
{
  "maleRatio": 0.5
}
```

### 5. catchRate（捕获率）

**参数**:
```python
catch_rate: int = 45  # 范围: 3-255
```

**参考值**:
- `3`: 传说宝可梦（超难捕获）
- `45`: 进化型（常规难度）
- `120`: 初始形态（较易捕获）
- `255`: 最易捕获

**JSON 结构**:
```json
{
  "catchRate": 45
}
```

### 6. baseFriendship（初始亲密度）

**参数**:
```python
base_friendship: int = 50  # 范围: 0-255
```

**参考值**:
- `0`: 野生传说宝可梦
- `35`: 野生普通宝可梦
- `50`: 默认值
- `70`: 容易亲近的宝可梦
- `140`: 伊布等特殊宝可梦

**JSON 结构**:
```json
{
  "baseFriendship": 50
}
```

### 7. height & weight（体型）

**参数**:
```python
height: float = 1.0  # 米
weight: float = 10.0  # 千克
```

**JSON 结构**:
```json
{
  "height": 0.7,
  "weight": 6.9
}
```

### 8. eggCycles（孵蛋周期）

**参数**:
```python
egg_cycles: int = 20  # 每个周期 = 257步
```

**参考值**:
- `10`: 快速孵化（如波波）
- `20`: 默认
- `40`: 稀有宝可梦
- `120`: 传说宝可梦（如超梦）

**JSON 结构**:
```json
{
  "eggCycles": 20
}
```

### 9. baseScale & hitbox（缩放和碰撞箱）

**参数**:
```python
base_scale: float = 1.0
hitbox_width: float = 1.0
hitbox_height: float = 1.0
```

**JSON 结构**:
```json
{
  "baseScale": 0.7,
  "hitbox": {
    "width": 0.8,
    "height": 0.9,
    "fixed": false
  }
}
```

### 10. drops（掉落物）

**参数**:
```python
drops: List[dict] = None  # [{"item": "minecraft:feather", "percentage": 50.0}]
```

**JSON 结构**:
```json
{
  "drops": {
    "amount": "1",
    "entries": [
      {
        "item": "minecraft:feather",
        "percentage": 50.0
      }
    ]
  }
}
```

## 📊 API 更新

### create_pokemon_with_stats 新增参数

```python
def create_pokemon_with_stats(
    # 原有参数...
    name: str,
    dex: int,
    primary_type: str,
    hp: int = 100,
    # ... 其他能力值
    
    # v1.4.0 新增参数
    secondary_type: str = None,
    abilities: List[str] = None,
    ev_hp: int = 0,
    ev_attack: int = 0,
    ev_defence: int = 0,
    ev_special_attack: int = 0,
    ev_special_defence: int = 0,
    ev_speed: int = 0,
    male_ratio: float = 0.5,
    catch_rate: int = 45,
    base_friendship: int = 50,
    height: float = 1.0,
    weight: float = 10.0,
    egg_cycles: int = 20,
    base_scale: float = 1.0,
    hitbox_width: float = 1.0,
    hitbox_height: float = 1.0,
    drops: List[dict] = None
) -> Dict:
    """创建宝可梦配置（v1.4.0 扩展版）"""
```

## ✅ 验证规则

### 1. 类型验证

**有效属性类型**:
```python
VALID_TYPES = [
    "normal", "fire", "water", "grass", "electric", "ice",
    "fighting", "poison", "ground", "flying", "psychic", "bug",
    "rock", "ghost", "dragon", "dark", "steel", "fairy"
]
```

### 2. 特性验证

**验证逻辑**:
1. 检查是否为有效特性名
2. 检查隐藏特性格式 (`h:` 前缀)
3. 限制最多 3 个特性

### 3. 努力值验证

**验证逻辑**:
1. 每个 EV 值：0-3
2. 总和 ≤ 3
3. 至少有一项 > 0（建议）

### 4. 性别比例验证

**验证逻辑**:
1. `-1` 或 `0.0-1.0`
2. 特殊宝可梦（如超梦）应为 `-1`

## 🧪 测试计划

### 1. 单元测试

- [ ] 类型验证测试
- [ ] 特性验证测试
- [ ] 努力值验证测试
- [ ] 性别比例验证测试

### 2. 集成测试

生成以下测试包：

1. **双属性宝可梦**
   - Dragonair（Dragon/Water）

2. **特殊性别比例**
   - Nidoran♀ (maleRatio=0.0)
   - Nidoran♂ (maleRatio=1.0)

3. **高努力值宝可梦**
   - Blissey (HP=3)
   - Chansey (HP=2)

4. **特殊捕获率**
   - Legendary (catchRate=3)
   - Starter (catchRate=45)

5. **完整配置示例**
   - 包含所有新字段的综合测试

## 📈 预期覆盖率提升

| 类别 | v1.3.0 | v1.4.0 | 提升 |
|------|--------|--------|------|
| 基础字段 | 40% | 75% | +35% |
| 进化系统 | 60% | 60% | - |
| **总体覆盖率** | **45%** | **65%** | **+20%** |

## 🚀 后续版本规划

### v1.5.0: 高级进化机制
- 性别条件进化
- 性格条件进化（properties）
- 多形态系统基础

### v1.6.0: 完整形态系统
- Forms 配置
- Aspects 支持
- 地区形态

### v1.7.0: 生蛋和掉落优化
- 动态生蛋组
- 自定义掉落物
- 经验组优化

---

**文档版本**: v1.4.0-design-001  
**最后更新**: 2025-10-23

